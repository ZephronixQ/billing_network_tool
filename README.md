# billing_network_tool

Асинхронный CLI-инструмент для диагностики оборудования доступа (**GPON / IPoE**)  
ориентированный на **стабильный и предсказуемый сбор данных за одну Telnet-сессию**  
с последующим строгим парсингом CLI-вывода.

Проект предназначен для эксплуатации в сетях доступа и решает задачи
оперативной диагностики **ONU (OLT)** и **IPoE-коммутаторов**.

---

## Основные возможности

### GPON (ONU / OLT)

* Поиск ONU по серийному номеру
* Определение PON-порта подключения
* Сбор IP-статуса (IP / MAC / VLAN)
* Анализ DHCP snooping
* Получение оптических уровней (PON power)
* Определение статуса ONU и интерфейса
* Определение скорости и трафика
* Получение детальных логов (authpass / offline / cause)

### IPoE (Access Switch)

* Определение вендора по CLI (vendor detect)
* Получение информации об устройстве
* Статус и параметры порта
* MAC-таблица
* DHCP relay / snooping
* Port utilization / counters
* MAC-protect / security
* Просмотр логов устройства

---

## Ключевые архитектурные принципы

### 1. One Session – One Request

* **GPON**:  
  После определения ONU-интерфейса все команды выполняются **одним `send_bulk`**,  
  все парсеры работают по **единому `raw_all` буферу**.

* **IPoE**:  
  Все команды выполняются **в рамках одной Telnet-сессии**  
  через план запросов (`query plan`) и prompt-based чтение.

Это устраняет:

* race condition
* потерю вывода команд
* нестабильность CLI
* зависимость от порядка выполнения

---

### 2. Отсутствие повторных запросов

Проект **принципиально не использует**:

* retry
* sleep-циклы
* повторные Telnet-подключения

Стабильность достигается:
* корректным ожиданием CLI-вывода
* маркерами завершения
* prompt-based чтением

---

### 3. Чёткое разделение ответственности

* `connection/` — транспорт, Telnet, таймауты
* `commands/` — **только CLI-команды**
* `query/` — планы выполнения команд
* `parsers/` — **только парсинг текста**
* `tables/` — форматированный вывод
* `adapter/` — orchestration логика
* `render/` — финальный вывод данных
* `service.py` — high-level workflow

---

## Архитектура проекта

Полная актуальная схема проекта находится здесь:

📄 **[cheme.md](./cheme.md)**

(содержит GPON + IPoE, все adapters, parsers, tables, render и vendor-логику)

---

## Установка зависимостей

Проект использует стандартный набор Python-библиотек, указанный в файле `requirements.txt`.

Для установки всех зависимостей выполните:

```bash
pip install -r requirements.txt
```

---

## Пример использования

### GPON (ONU)

```bash
python3 main.py --sn XCTFAF21084E
```
---

## Пример вывода (GPON)

```text
✅ ONU FOUND
╒═════════════╤══════════╤══════════════╤══════════╕
│     IP      │   PORT   │    SERIAL    │       ID │
╞═════════════╪══════════╪══════════════╪══════════╡
│ 192.168.2.1 │  1/1/1:1 │ XCTFAF21084E │ 10011710 │
╘═════════════╧══════════╧══════════════╧══════════╛

🌐 IP STATUS
╒═════════════╤════════════════╤════════╕
│     IP      │      MAC       │   VLAN │
╞═════════════╪════════════════╪════════╡
│ 172.10.1.11 │ 0C14.11aa.88cf │   2025 │
╘═════════════╧════════════════╧════════╛

📡 PON POWER LEVELS
╒═══════╤════════════════╤════════════════╤═══════════════╕
│  DIR  │      OLT       │      ONU       │   ATTENUATION │
╞═══════╪════════════════╪════════════════╪═══════════════╡
│  UP   │ Rx -27.786 dBm │  Tx 1.814 dBm  │        29.6   │
├───────┼────────────────┼────────────────┼───────────────┤
│ DOWN  │  Tx 5.027 dBm  │ Rx -20.706 dBm │        25.733 │
╘═══════╧════════════════╧════════════════╧═══════════════╛

⚡ OPERATE / SPEED / THROUGHPUT
╒══════════════════╤════════════════╤═══════════════════════╤════════════════════════╕
│  Operate status  │  Speed status  │   Input rate (Mbit/s) │   Output rate (Mbit/s) │
╞══════════════════╪════════════════╪═══════════════════════╪════════════════════════╡
│      enable      │    full-100    │                 0.018 │                  0.021 │
╘══════════════════╧════════════════╧═══════════════════════╧════════════════════════╛

📝 ONU DETAIL LOGS
╒═════╤═════════════════════╤═════════════════════╤═══════════╕
│   # │    Authpass Time    │    Offline Time     │   Cause   │
╞═════╪═════════════════════╪═════════════════════╪═══════════╡
│   1 │ 2025-12-19 15:46:50 │ 2025-12-22 10:53:25 │ DyingGasp │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   2 │ 2025-12-22 10:57:43 │ 2025-12-22 13:00:17 │   LOSi    │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   3 │ 2025-12-22 13:01:35 │ 2025-12-22 16:47:45 │ DyingGasp │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   4 │ 2025-12-22 16:49:24 │ 2025-12-24 11:09:01 │    LOS    │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   5 │ 2025-12-24 11:10:19 │ 2025-12-24 11:28:03 │ DyingGasp │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   6 │ 2025-12-24 11:29:16 │ 2025-12-24 11:30:58 │ DyingGasp │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   7 │ 2025-12-24 11:32:08 │ 2025-12-24 11:32:24 │ DyingGasp │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   8 │ 2025-12-24 11:33:09 │ 2025-12-27 18:04:25 │ DyingGasp │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│   9 │ 2025-12-27 18:05:43 │ 2025-12-27 19:36:15 │ DyingGasp │
├─────┼─────────────────────┼─────────────────────┼───────────┤
│  10 │ 2025-12-27 19:37:26 │ 0000-00-00 00:00:00 │           │
╘═════╧═════════════════════╧═════════════════════╧═══════════╛
```

### IPoE

```bash
python3 main.py --ipoe 192.168.1.24 11
```
---

## Пример вывода (IPoe)

```
🖥 DEVICE INFO
╒══════════╤═════════╤═════════════════╕
│  VENDOR  │  MODEL  │      PORTS      │
╞══════════╪═════════╪═════════════════╡
│   ZTE    │  2928E  │ 24FE + 4GE (28) │
╘══════════╧═════════╧═════════════════╛

🔌 PORT STATUS
╒════════╤═════════╤═════════╤═════════╤══════════╕
│   PORT │  STATE  │  SPEED  │  INPUT  │  OUTPUT  │
╞════════╪═════════╪═════════╪═════════╪══════════╡
│     11 │   UP    │ 100Mbps │  0.01%  │  0.00%   │
╘════════╧═════════╧═════════╧═════════╧══════════╛

🛡 MAC PROTECT
╒══════════╤══════════════╤══════════╕
│  STATUS  │  IS-PROTECT  │  ACTION  │
╞══════════╪══════════════╪══════════╡
│  Enable  │      No      │ Restrict │
╘══════════╧══════════════╧══════════╛

✅ MAC FOUND
╒════════════════╤════════╤════════╤═════════════╕
│  MAC ADDRESS   │   VLAN │   PORT │     AGE     │
╞════════════════╪════════╪════════╪═════════════╡
│ 01ef.a818.bff4 │   2025 │     11 │ 00:02:08:09 │
╘════════════════╧════════╧════════╧═════════════╛

✅ DHCP BINDING
╒══════════════╤════════╤════════╕
│  IP ADDRESS  │   VLAN │   PORT │
╞══════════════╪════════╪════════╡
│ 172.11.17.11 │   2025 │     11 │
╘══════════════╧════════╧════════╛

📜 DEVICE LOGS
╒══════════════════════════╤════════╤══════════╕
│           TIME           │   PORT │  EVENT   │
╞══════════════════════════╪════════╪══════════╡
│ Wed Dec 31 08:04:59 2025 │     11 │  linkup  │
├──────────────────────────┼────────┼──────────┤
│ Wed Dec 31 08:04:46 2025 │     11 │ linkdown │
├──────────────────────────┼────────┼──────────┤
│ Wed Dec 31 08:04:44 2025 │     11 │  linkup  │
├──────────────────────────┼────────┼──────────┤
│ Tue Dec 30 22:16:55 2025 │     11 │ linkdown │
╘══════════════════════════╧════════╧══════════╛
```
---

## Поддерживаемое оборудование

### GPON

* ZTE ZXAN OLT
* GPON ONU

### IPoE

* ZTE Access Switch (IPoE)

---

## Обработка ошибок

* Недоступный хост
* Таймаут соединения
* Refused connection
* Неопознанный вендор
* Пустой или неполный CLI-вывод

Все ошибки обрабатываются **до начала парсинга**.

---

## Ограничения

* Проект ориентирован на **ZTE CLI**
* Для других вендоров требуется:

  * vendor detect
  * adapter
  * commands / query
  * parsers / tables


---


